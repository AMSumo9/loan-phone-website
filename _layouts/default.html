// REPLACE THE SCRIPT SECTION IN YOUR DEFAULT.HTML WITH THIS OPTIMIZED VERSION

<script>
// OPTIMIZED: Minimal critical JavaScript only
document.addEventListener('DOMContentLoaded', function() {
  // CRITICAL: Theme toggle functionality
  const themeToggles = document.querySelectorAll('#theme-toggle-desktop, #theme-toggle-mobile');
  const htmlEl = document.documentElement;
  const currentTheme = localStorage.getItem('theme') || 'light';
  
  htmlEl.classList.add(currentTheme);
  themeToggles.forEach(toggle => {
    toggle.innerHTML = currentTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    toggle.addEventListener('click', () => {
      htmlEl.classList.toggle('dark');
      const newTheme = htmlEl.classList.contains('dark') ? 'dark' : 'light';
      localStorage.setItem('theme', newTheme);
      toggle.innerHTML = newTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    });
  });

  // CRITICAL: Mobile menu
  const mobileMenuButton = document.getElementById('mobile-menu-button');
  const mobileMenu = document.getElementById('mobile-menu');
  if (mobileMenuButton && mobileMenu) {
    mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('active'));
  }
});

// OPTIMIZED: Load non-critical functionality after user interaction
let interactionStarted = false;

function loadNonCriticalScripts() {
  if (interactionStarted) return;
  interactionStarted = true;

  // Load scroll animations only after interaction
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) entry.target.classList.add('is-visible');
    });
  }, { threshold: 0.1 });
  
  document.querySelectorAll('.animate-on-scroll').forEach(el => observer.observe(el));

  // Load back-to-top functionality
  const backToTopButton = document.getElementById('back-to-top');
  if (backToTopButton) {
    let ticking = false;
    function updateBackToTop() {
      if (window.scrollY > 300) {
        backToTopButton.classList.add('active');
      } else {
        backToTopButton.classList.remove('active');
      }
      ticking = false;
    }

    window.addEventListener('scroll', () => {
      if (!ticking) {
        requestAnimationFrame(updateBackToTop);
        ticking = true;
      }
    }, { passive: true });

    backToTopButton.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  }

  // OPTIMIZED: Load tracking scripts after interaction (if production)
  {% if jekyll.environment == "production" %}
  if (!window.trackingLoaded) {
    window.trackingLoaded = true;
    
    // Minimal GTM load
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MLJ92WJ4');

    // Minimal Facebook Pixel
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '1490822172125687');
    fbq('track', 'PageView');
  }
  {% endif %}
}

// OPTIMIZED: Load on first interaction OR after 2 seconds (whichever comes first)
['mousedown', 'touchstart', 'keydown', 'scroll'].forEach(event => {
  document.addEventListener(event, loadNonCriticalScripts, { once: true, passive: true });
});
setTimeout(loadNonCriticalScripts, 2000);

// Modal functions (keep these critical)
window.openSupportModal = function() {
  const modal = document.getElementById('support-modal');
  if (modal) {
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
};

window.closeSupportModal = function() {
  const modal = document.getElementById('support-modal');
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
  }
};

// Close modal handlers
document.addEventListener('click', function(event) {
  const modal = document.getElementById('support-modal');
  if (event.target === modal) closeSupportModal();
});

document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') closeSupportModal();
});
</script>
